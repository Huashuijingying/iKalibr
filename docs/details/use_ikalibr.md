<div style="text-align: center;">
    <img src="../img/logo.svg" style="width: 100vw; height: auto;">
</div>

---

<h3 align="center">Tutorial: General Calibration Procedure in iKalibr</h3>
<p align="center">
    <a href="https://github.com/Unsigned-Long"><strong>Author » Shuolong Chen</strong></a>
</p>

---

<p align="left">
    <a><strong>Collect Sufficiently Excited Sensor Data »</strong></a>
</p> 

Sufficiently excited motion is required for accurate spatiotemporal calibration in `iKalibr` (to ensure the observability of spatiotemporal parameters). This is a less noticeable but very important point, and we have to be ready at the starting line.

Here we give a guiding data collection motion incentive method, see the following demo videos. The key is to make a circular motion, shaking your sensor in a 8-shape pattern as you go. **Be careful not to shake too fast or too slow**. 

https://github.com/Unsigned-Long/iKalibr/assets/76953144/66bccd20-3aaa-4c76-8d32-b49a211f3c92

If you are calibrating a Livox LiDAR (**small FoV solid-state LiDAR**, such as Livox Avia, not for Livox Mid-360, it has large FoV and can support the above data collection motion), you are recommended to follow the following motion to collect your data, as such motion is helpful for NDT-based LiDAR-only odometer in initialization in `iKalibr`:



https://github.com/Unsigned-Long/iKalibr/assets/76953144/3b5cd230-fb6e-491f-baf4-cec8872c54a7



In fact, these animations can be generated and viewed on your computer through [ikalibr-learn.launch](../../launch/nofree/ikalibr-learn.launch). Just run:

```sh
roslaunch ikalibr ikalibr-learn.launch
```

Of course, this is not the only way. You can do it according to your way, as long as you ensure that the collected data is fully excited.

<p align="left">
    <a><strong>Write An Adaptable Configure File »</strong></a>
</p> 

A template of configure file has been provided [here](config_template_note.md). The detailed notes are also provided. We highly recommend you to read it before performing configuring and further solving, if it's your first time.
Of course, you can also find any configuration file corresponding to our open-source dataset directly in the `ikalibr/data` folder and modify it to adapt your own sensor kit, which may help you get started faster.

<p align="left">
    <a><strong>Perform Calibration Using iKalibr »</strong></a>
</p> 

Finally, we can launch the `ikalibr` ros node to perform spatiotemporal determination for a given sensor suite. Just run the following command:

+ The **first** way: use `rosrun`, the `roscore` should be ready. The `path_of_your_config_file` is the filename pointing to your own `yaml`-format configure file.

  ```sh
  rosrun ikalibr ikalibr_prog _config_path:="path_of_your_config_file"
  ```

+ The **second** way: use `roslaunch`. Before launch, you have to pass the filename of your own `yaml`-format configure file to `ikalibr-prog.launch` in directory `ikalibr/launch/solver`.

  ```sh
  roslaunch ikalibr ikalibr-prog.launch
  ```

  Here is the detailed launch file:

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <launch>
      <arg name="config_path" default="$(find ikalibr)/config/ikalibr-config.yaml"/>
  
      <node pkg="ikalibr" type="ikalibr_prog" name="ikalibr_prog" output="screen">
          <!-- change the value of this field to the path of your self-defined config file -->
          <param name="config_path" value="$(arg config_path)" type="string"/>
      </node>
  </launch>
  ```

+ The third way: use `roslaunch`, but passing in the config path in command Line:

  ```sh
  roslaunch ikalibr ikalibr-prog.launch config_path:="path_of_your_config_file"
  ```

  


<p align="left">
    <a><strong>Perform SfM Using Colmap »</strong></a>
</p> 


If cameras are integrated in your sensor suite, and you want to calibrate their spatiotemporal parameters in `iKalibr`, structure from motion (SfM) is required for each camera, which can be conducted by the well-known SfM toolkit [colmap](https://github.com/colmap/colmap.git). **Attention**: this only holds for optical cameras, for RGBD cameras with depth information, no SfM is required for spatiotemporal calibration in `iKalibr`!

In order to reduce the complexity of this operation as much as possible, we have written the **corresponding command lines** to achieve this quickly and conveniently. Specifically, after you run the `ikalibr_prog` program, it will determine whether there are SfM result files generated by `colmap` in the current workspace. If not, `ikalibr_prog` will output the corresponding images and an information file, as well as **a command line file** for `colmap` to perform SfM, which records the specific commands to be executed. You just need to run the commands in the file in the terminal one by one.

Here is an example (these commands would generated by `ikalibr_prog` adaptively):

```sh
# command line for 'feature_extractor' in colmap for topic '/camera/frame'
colmap feature_extractor --database_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws/database.db --image_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/images --ImageReader.camera_model PINHOLE --ImageReader.single_camera 1 --ImageReader.camera_params 883.498,882.135,505.742,401.460

# command line for 'matches_importer' in colmap for topic '/camera/frame'
colmap matches_importer --database_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws/database.db --match_list_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws/matches.txt --match_type pairs

# SfM Reconstruction in [COLMAP GUI | COLMAP MAPPER | GLOMAP MAPPER (RECOMMEND)]
# ---------------------
# - Way 1: COLMAP GUI -
# ---------------------
colmap gui --database_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws/database.db --image_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/images
# ------------------------
# - Way 2: COLMAP MAPPER -
# ------------------------
colmap mapper --database_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws/database.db --image_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/images --output_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws --Mapper.init_min_tri_angle 25 --Mapper.init_max_error 1 --Mapper.tri_min_angle 3 --Mapper.ba_refine_focal_length 0 --Mapper.ba_refine_principal_point 0
# ------------------------------------
# - Way 3: GLOMAP MAPPER (RECOMMEND) -
# ------------------------------------
glomap mapper --database_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws/database.db --image_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/images --output_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws

# command line for 'model_converter' in colmap for topic '/camera/frame'
colmap model_converter --input_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws/0 --output_path /home/csl/ros_ws/iKalibr/src/ikalibr/data/real-world-old/data_2023926145954/images/camera/frame/sfm_ws --output_type TXT
```

**Key point**: the pipeline of sparse SfM in `colmap` is:

+ *Feature extraction*: use `SIFT` feature extraction algorithm to extract features from images. This is conducted by `colmap feature_extractor`.
+ *Feature matching*: given two images, feature matching is performed using the extracted `SIFT` feature descriptors. This is conducted by `colmap matches_importer`.
+ *SfM sparse reconstruction*: structural reconstruction via bundle adjustment (BA). Please note that we provide three methods here: *command-line-based method* (`colmap mapper` and `glomap mapper`) and *GUI-based method* `colmap gui`. If you use `colmap gui`, you need to manually save the result files to the `sfm_ws` folder, and then use `model_converter` to convert the binary-format files to txt-format ones so that `iKalibr` can read them. We strongly recommend that you use the `glomap mapper` (the third way) for fast SfM reconstruction (`glomap mapper` is compatible in `iKalibr` since [v1.2.0](https://github.com/Unsigned-Long/iKalibr/releases/tag/v1.2.0)).
+ *Convert the SfM result files*: use `colmap model_converter` to convert binary-format files to txt-format ones **in folder `sfm_ws`**. They are `cameras.txt`, `images.txt`, and `points3D.txt`.

The following one is a typical file structure after performing SfM using `colmap`:

```sh
.
├── images                   # output by ikalibr_prog
│   ├── 1548685768126.jpg
│   ├── 1548685768226.jpg
│   ├── ...
├── info.yaml                # output by ikalibr_prog [used in solving]
└── sfm_ws         
    ├── 0                    # output by colmap
    │   ├── cameras.bin
    │   ├── images.bin
    │   ├── points3D.bin
    │   └── project.ini
    ├── cameras.txt          # converted from colmap  [used in solving]
    ├── database.db          # output by colmap
    ├── images.txt           # converted from colmap  [used in solving]
    ├── matches.txt          # output by ikalibr_prog
    ├── points3D.txt         # converted from colmap  [used in solving]
    └── sfm-command-line.txt # output by ikalibr_prog
```

