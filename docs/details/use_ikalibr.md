<div align=center><img src="../img/logo.svg" width =100%></div>

---

<h3 align="center">Tutorial: General Calibration Procedure in iKalibr</h3>
<p align="center">
    <a href="https://github.com/Unsigned-Long"><strong>Author » Shuolong Chen</strong></a>
</p>

---

<p align="left">
    <a><strong>Collect Sufficiently Excited Sensor Data »</strong></a>
</p> 

Sufficiently excited motion is required for accurate spatiotemporal calibration in `iKalibr` (to ensure the observability of spatiotemporal parameters). This is a less noticeable but more important point, and we have to be ready at the starting line.

+ todo...

<p align="left">
    <a><strong>Write An Adaptable Configure File »</strong></a>
</p> 

A template of configure file has been provided [here](config_template_note.md). The detailed notes are also provided. We highly recommend you to read it before performing configuring and further solving, if it's your first time.

<p align="left">
    <a><strong>Perform Calibration Using iKalibr »</strong></a>
</p> 

Finally, we can launch the `ikalibr` ros node to perform spatiotemporal determination for a given sensor suite. Just run the following command:

+ ***way** **one***: use `rosrun`, the `roscore` should be ready. The `path_of_your_config_file` is the filename pointing to your own `yaml`-format configure file.

  ```sh
  rosrun ikalibr ikalibr_prog _config_path:="path_of_your_config_file"
  ```

+ ***way** **two***: use `roslaunch`. Before launch, you have to pass the filename of your own `yaml`-format configure file to `ikalibr-prog.launch` in directory `ikalibr/launch/solver`.

  ```sh
  roslaunch ikalibr ikalibr-prog.launch
  ```

  Here is the detailed launch file:

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <launch>
      <node pkg="ikalibr" type="ikalibr_prog" name="ikalibr_prog" output="screen">
          <!-- change the value of this field to the path of your self-defined config file -->
          <param name="config_path" value="path_of_your_config_file" type="string"/>
      </node>
  </launch>
  ```


<p align="left">
    <a><strong>Perform SfM Using Colmap »</strong></a>
</p> 

If cameras are integrated in your sensor suite, and you want to calibrate their spatiotemporal parameters in `iKalibr`, structure from motion (SfM) is required for each camera, which can be conducted by the well-known SfM toolkit [colmap](https://github.com/colmap/colmap.git).

In order to reduce the complexity of this operation as much as possible, we have written the **corresponding command lines** to achieve this quickly and conveniently. Specifically, after you run the `ikalibr_prog` program, it will determine whether there are SfM result files generated by `colmap` in the current workspace. If not, `ikalibr_prog` will output the corresponding images and an information file, as well as **a command line file** for `colmap` to perform SfM, which records the specific commands to be executed. You just need to run the commands in the file in the terminal one by one.

Here is an example (these commands would generated by `ikalibr_prog` adaptively):

```sh
# command line for 'feature_extractor' in colmap for topic '/cam0/frame':
colmap feature_extractor --database_path /home/.../images/cam0/frame/sfm_ws/database.db --image_path /home/.../images/cam0/frame/images --ImageReader.camera_model PINHOLE --ImageReader.single_camera 1 --ImageReader.camera_params 743.429,743.555,618.719,506.728

# command line for 'matches_importer' in colmap for topic '/cam0/frame':
colmap matches_importer --database_path /home/.../images/cam0/frame/sfm_ws/database.db --match_list_path /home/.../images/cam0/frame/sfm_ws/matches.txt --match_type pairs

# SfM Reconstruction in COLMAP [colmap gui] (recommend) or [colmap mapper]  -
# performing SfM using [colmap gui] is suggested, rather than the command line, 
# which is strict in initialization (finding initial image pair) and would cost lots of time!!!
# command line for 'colmap gui' for topic '/cam0/frame':
colmap gui --database_path /home/.../images/cam0/frame/sfm_ws/database.db --image_path /home/.../images/cam0/frame/images
# command line for 'colmap mapper' for topic '/cam0/frame':
colmap mapper --database_path /home/.../images/cam0/frame/sfm_ws/database.db --image_path /home/.../images/cam0/frame/images --output_path /home/.../images/cam0/frame/sfm_ws --Mapper.init_min_tri_angle 25 --Mapper.init_max_error 1 --Mapper.tri_min_angle 3 --Mapper.ba_refine_focal_length 0 --Mapper.ba_refine_principal_point 0

# command line for 'model_converter' in colmap for topic '/cam0/frame':
colmap model_converter --input_path /home/.../images/cam0/frame/sfm_ws/0 --output_path /home/.../images/cam0/frame/sfm_ws --output_type TXT
```

**Key point**: the pipeline of sparse SfM in `colmap` is:

+ *Feature extraction*: use `SIFT` feature extraction algorithm to extract features from images. This is conducted by `colmap feature_extractor`.
+ *Feature matching*: given two images, feature matching is performed using the extracted `SIFT` feature descriptors. This is conducted by `colmap matches_importer`.
+ *SfM sparse reconstruction*: structural reconstruction via bundle adjustment (BA). Please note that we provide two methods here: *command line based method* (`colmap mapper`) and *GUI based method* `colmap gui`. **We recommend using the GUI** so that you can see in real time whether the SfM reconstruction is correct. Of course, if you use this mode, you will need to **manually set the reconstruction options** in the GUI interface (detailed options to set can be found in the given command line based reconstruction, `colmap mapper`, such as `--Mapper.init_min_tri_angle` option, `--Mapper.ba_refine_principal_point` option, and so on).
